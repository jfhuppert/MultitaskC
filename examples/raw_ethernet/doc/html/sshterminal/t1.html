<HTML
><HEAD
><TITLE
>Serving SSH sessions</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.7"></HEAD
><BODY
CLASS="article"
><DIV
CLASS="ARTICLE"
><DIV
CLASS="TITLEPAGE"
><H1
CLASS="title"
><A
NAME="AEN2"
></A
>Serving SSH sessions</H1
><H3
CLASS="author"
><A
NAME="AEN4"
>Ken Yap, ken_yap AT users PERIOD sourceforge PERIOD net</A
></H3
><P
CLASS="pubdate"
>7 January 1999<BR></P
><DIV
><DIV
CLASS="abstract"
><A
NAME="AEN7"
></A
><P
></P
><P
>&#13;This document shows how to provide a login session that directly
connects to remote hosts with SSH.
</P
><P
></P
></DIV
></DIV
><HR></DIV
><P
>&#13;I wanted a login program that would connect the user directly to a remote
host with SSH. At first I thought of writing my own login program, then
I remembered that mgetty could be configured to call any login program.
So here's what I did:

</P
><P
>&#13;In <TT
CLASS="filename"
>/etc/mgetty+sendfax/login.config</TT
> I added the line:

</P
><P
>&#13;
<TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="programlisting"
>&#13;*@*		sshguest	@	/usr/local/etc/mgetty-ssh @
</PRE
></TD
></TR
></TABLE
>

</P
><P
>&#13;In <TT
CLASS="filename"
>/etc/inittab</TT
> I added the line:

</P
><P
>&#13;
<TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="programlisting"
>&#13;8:35:respawn:/sbin/mgetty -r tty8
</PRE
></TD
></TR
></TABLE
>

</P
><P
>&#13;I picked a free virtual tty, you may want to expand this to other
ttys later.

</P
><P
>&#13;In <TT
CLASS="filename"
>etc/mgetty+sendfax/mgetty.config</TT
> I added the
lines:

</P
><P
>&#13;
<TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="programlisting"
>&#13;port tty8
toggle-dtr n
ignore-carrier y
blocking y
direct y
login-time -1
</PRE
></TD
></TR
></TABLE
>

</P
><P
>&#13;Thanks to Gert Doering (mgetty author) for the advice on the above
settings.

</P
><P
>&#13;I added this user to <TT
CLASS="filename"
>/etc/passwd</TT
>:

</P
><P
>&#13;
<TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="programlisting"
>&#13;sshguest:*:199:199:SSH guest:/tmp:
</PRE
></TD
></TR
></TABLE
>

</P
><P
>&#13;If you are using shadow passwords you should also add an entry to
<TT
CLASS="filename"
>/etc/shadow</TT
>.

</P
><P
>&#13;The <TT
CLASS="filename"
>mgetty-ssh</TT
> Perl script mentioned above is:

</P
><P
>&#13;
<TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="programlisting"
>&#13;#!/usr/bin/perl
die "No argument\n" if !defined($ARGV[0]);
($name, $host) = split /@/, $ARGV[0];
# remove leading non-alphanums from name and host to prevent
# masquerading as arguments
$name =~ s/^[^a-z0-9]*//;
$host =~ s/^[^a-z0-9]*//;
# remove whitespace as well
$name =~ s/[ \t\f]//g;
$host =~ s/[ \t\f]//g;
# limit length of strings
$name = substr($name, 0, 64);
$host = substr($host, 0, 256);
# do we have anything left?
die "Name or host null\n" if ($name eq '' or $host eq '');
exec '/usr/bin/ssh', '-e', 'none', '-o', 'FallBackToRsh=no',
	'-o', 'StrictHostKeyChecking=yes', '-l', $name, $host;
</PRE
></TD
></TR
></TABLE
>

</P
><P
>&#13;Make sure this script is executable. If you are concerned that Perl
takes up too much resources for a transient script, feel free to write
the C equivalent.

</P
><P
>&#13;Make sure any remote hosts you want to connect to have their public keys
in <TT
CLASS="filename"
>/etc/ssh/ssh_known_hosts</TT
>

</P
><P
>&#13;Now on tty8 enter user@remote as the login name. You will get the
following:

</P
><P
>&#13;
<TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="programlisting"
>&#13;Red Hat Linux release 5.2 (Apollo)
Kernel 2.0.36 on an i486

login: user@remote
user@remote's password:
Last login: Fri Dec 25 10:34:12 1998 from xterm.foo.com.au
No mail.
[user@remote user]$
</PRE
></TD
></TR
></TABLE
>

</P
><P
>&#13;After I did this for mgetty, Peter Samuel pointed me to rungetty
which is essentially an enhanced mingetty but can invoke programs other
than login. Unlike mgetty, rungetty does not have any pattern matching
facilities on the login name or indeed any means of passing the login
name to the script. We get around this by prompting for the name in the
script itself.

</P
><P
>&#13;In <TT
CLASS="filename"
>/etc/inittab</TT
>, add the line:

</P
><P
>&#13;
<TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="programlisting"
>&#13;8:35:respawn:/usr/local/sbin/rungetty -u sshguest tty8 -- /usr/local/etc/rungetty-ssh
</PRE
></TD
></TR
></TABLE
>

</P
><P
>&#13;The <TT
CLASS="filename"
>rungetty-ssh</TT
> script is essentially the same as
the <TT
CLASS="filename"
>mgetty-ssh</TT
> script but with a section to prompt
for the login name:

</P
><P
>&#13;
<TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="programlisting"
>&#13;#!/usr/bin/perl
$| = 1;
do {
	print "SSH to user\@host: ";
} while (!defined(sysread(STDIN, $_, 100)));
chomp($_);
($name, $host) = split /@/, $_;
# remove leading non-alphanums from name and host to prevent
# masquerading as arguments
$name =~ s/^[^a-z0-9]*//;
$host =~ s/^[^a-z0-9]*//;
# remove whitespace as well
$name =~ s/[ \t\f]//g;
$host =~ s/[ \t\f]//g;
# limit length of strings
$name = substr($name, 0, 64);
$host = substr($host, 0, 256);
# do we have anything left?
die "Name or host null\n" if ($name eq '' or $host eq '');
exec '/usr/bin/ssh', '-e', 'none', '-o', 'FallBackToRsh=no',
	'-o', 'StrictHostKeyChecking=yes', '-l', $name, $host;
</PRE
></TD
></TR
></TABLE
>

</P
><P
>&#13;The disadvantage is that when the prompt is active, this Perl script is
always running. This offsets the gains made by using the lighter
rungetty in place of mgetty. You may prefer to rewrite this in C to keep
it very light.

</P
><P
>&#13;This technique could be used on diskless workstations to provide login
sessions to remote hosts.

</P
></DIV
></BODY
></HTML
>